// clawcontrol - Database Schema
// SQLite with WAL mode for local-first performance
//
// WARNING: Use `prisma migrate dev` for schema changes.
// NEVER use `prisma db push` — it causes drift between schema and migrations.

generator client {
  provider = "prisma-client-js"
  // Output to root node_modules for npm workspaces compatibility
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// WORK ORDERS
// ============================================================================

model WorkOrder {
  id              String   @id @default(cuid())
  code            String   @unique // WO-0001 format, auto-generated
  title           String
  goalMd          String   @map("goal_md")
  state           String   @default("planned") // planned|active|blocked|review|shipped|cancelled
  priority        String   @default("P2") // P0|P1|P2|P3
  owner           String   @default("user") // legacy compatibility label (prefer ownerType/ownerAgentId)
  ownerType       String   @default("user") @map("owner_type") // user|agent|system
  ownerAgentId    String?  @map("owner_agent_id")
  tags            String   @default("[]") // JSON array of labels
  routingTemplate String   @default("default_routing") @map("routing_template")

  // Workflow chain tracking
  workflowId    String? @map("workflow_id") // e.g., "feature_request"
  currentStage  Int     @default(0) @map("current_stage")

  blockedReason   String?  @map("blocked_reason")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  shippedAt       DateTime? @map("shipped_at")

  // Relations
  operations Operation[]
  operationStories OperationStory[]
  approvals  Approval[]
  artifacts  Artifact[]
  receipts   Receipt[]
  messages   Message[]

  @@index([state])
  @@index([priority])
  @@index([owner])
  @@index([ownerType])
  @@index([ownerAgentId])
  @@index([workflowId])
  @@index([createdAt])
  @@map("work_orders")
}

model WorkOrderSequence {
  id        Int      @id
  nextValue Int      @default(1) @map("next_value")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("work_order_sequences")
}

// ============================================================================
// OPERATIONS
// ============================================================================

model Operation {
  id                      String   @id @default(cuid())
  workOrderId             String   @map("work_order_id")
  station                 String   // spec|build|qa|ops|update|ship|compound
  title                   String
  notes                   String?
  status                  String   @default("todo") // todo|in_progress|blocked|review|done|rework
  assigneeAgentIds        String   @default("[]") @map("assignee_agent_ids") // JSON array
  dependsOnOperationIds   String   @default("[]") @map("depends_on_operation_ids") // JSON array
  wipClass                String   @default("implementation") @map("wip_class")
  blockedReason           String?  @map("blocked_reason")

  // Workflow chain tracking
  workflowId          String?   @map("workflow_id") // e.g., "feature_request"
  workflowStageIndex  Int       @default(0) @map("workflow_stage_index")
  iterationCount      Int       @default(0) @map("iteration_count")
  loopTargetOpId      String?   @map("loop_target_op_id") // for review → build loops
  executionType       String    @default("single") @map("execution_type") // single|loop
  loopConfigJson      String?   @map("loop_config_json") // JSON
  currentStoryId      String?   @map("current_story_id")
  retryCount          Int       @default(0) @map("retry_count")
  maxRetries          Int       @default(2) @map("max_retries")
  claimedBy           String?   @map("claimed_by")
  claimExpiresAt      DateTime? @map("claim_expires_at")
  lastClaimedAt       DateTime? @map("last_claimed_at")
  timeoutCount        Int       @default(0) @map("timeout_count")

  // Escalation tracking
  escalatedAt         DateTime? @map("escalated_at")
  escalationReason    String?   @map("escalation_reason")

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  approvals Approval[]
  artifacts Artifact[]
  receipts  Receipt[]
  stories   OperationStory[]

  @@index([workOrderId])
  @@index([status])
  @@index([station])
  @@index([workflowId])
  @@index([claimExpiresAt])
  @@index([executionType])
  @@map("operations")
}

// ============================================================================
// OPERATION STORIES (LOOP EXECUTION TRACKING)
// ============================================================================

model OperationStory {
  id                   String   @id @default(cuid())
  operationId          String   @map("operation_id")
  workOrderId          String   @map("work_order_id")
  storyIndex           Int      @map("story_index")
  storyKey             String   @map("story_key")
  title                String
  description          String
  acceptanceCriteriaJson String @map("acceptance_criteria_json") // JSON array
  status               String   @default("pending") // pending|running|done|failed
  outputJson           String?  @map("output_json") // JSON
  retryCount           Int      @default(0) @map("retry_count")
  maxRetries           Int      @default(2) @map("max_retries")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  operation Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([operationId, storyIndex])
  @@index([operationId, status])
  @@index([workOrderId])
  @@map("operation_stories")
}

// ============================================================================
// AGENTS
// ============================================================================

model Agent {
  id              String    @id @default(cuid())
  name            String    @unique // legacy alias for displayName
  displayName     String?   @map("display_name")
  slug            String?   @unique
  runtimeAgentId  String?   @map("runtime_agent_id")
  kind            String    @default("worker") // worker|manager|ceo|guard
  dispatchEligible Boolean  @default(true) @map("dispatch_eligible")
  nameSource      String    @default("system") @map("name_source") // system|openclaw|user
  role            String
  station         String
  teamId          String?   @map("team_id")
  status          String    @default("idle") // idle|active|blocked|error
  sessionKey      String    @unique @map("session_key")
  capabilities    String    @default("{}") @map("capabilities") // JSON object
  wipLimit        Int       @default(2) @map("wip_limit")
  avatarPath      String?   @map("avatar_path") // Custom avatar image path
  model           String?   @default("claude-sonnet-4-20250514") @map("model") // Primary AI model
  fallbacks       String?   @default("[]") @map("fallbacks") // JSON array of model IDs
  isStale         Boolean   @default(false) @map("is_stale")
  staleAt         DateTime? @map("stale_at")
  lastSeenAt      DateTime? @map("last_seen_at")
  lastHeartbeatAt DateTime? @map("last_heartbeat_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([station])
  @@index([teamId])
  @@index([displayName])
  @@index([kind])
  @@index([dispatchEligible])
  @@map("agents")
}

// ============================================================================
// AGENT TEAMS
// ============================================================================

model AgentTeam {
  id           String   @id @default(cuid())
  slug         String   @unique
  name         String
  description  String?
  source       String   @default("custom") // custom|imported|builtin
  workflowIds  String   @default("[]") @map("workflow_ids") // JSON array
  templateIds  String   @default("[]") @map("template_ids") // JSON array
  healthStatus String   @default("healthy") @map("health_status") // healthy|warning|degraded|unknown
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([source])
  @@index([healthStatus])
  @@map("agent_teams")
}

// ============================================================================
// STATIONS
// ============================================================================

model Station {
  /// Stable, user-facing id (kebab-case slug).
  id          String   @id
  /// Display name (must be unique).
  name        String   @unique
  /// Lucide icon key (kebab-case, e.g. "file-text").
  icon        String
  description String?
  /// Optional hex color (e.g. "#3B82F6").
  color       String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([sortOrder])
  @@map("stations")
}

// ============================================================================
// OPENCLAW SESSION TELEMETRY (NOT CANONICAL)
// ============================================================================

model AgentSession {
  id             String   @id @default(cuid())

  // Telemetry only — never canonical.
  sessionId      String   @unique @map("session_id")
  sessionKey     String   @map("session_key")
  agentId        String   @map("agent_id") // OpenClaw agentId (e.g. "main", "clawbuild")
  kind           String   @map("kind") // direct|isolated|...
  model          String?  @map("model")

  updatedAtMs    BigInt   @map("updated_at_ms")
  lastSeenAt     DateTime @map("last_seen_at")
  abortedLastRun Boolean  @default(false) @map("aborted_last_run")
  percentUsed    Int?     @map("percent_used")

  // Derived display state: active|idle|error
  state          String   @default("idle")

  // Explicit linkage (read-only; may be null)
  // Telemetry only — never canonical.
  operationId    String?  @map("operation_id")
  workOrderId    String?  @map("work_order_id")

  // Keep raw JSON for debugging (redacted status output is safe-ish, but treat as internal)
  rawJson        String   @default("{}") @map("raw_json")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([state])
  @@index([lastSeenAt])
  @@map("agent_sessions")
}

// ============================================================================
// USAGE + COST ANALYTICS (PHASE 1)
// ============================================================================

model UsageIngestionCursor {
  id           String   @id @default(cuid())
  sourcePath   String   @unique @map("source_path")
  agentId      String   @map("agent_id")
  sessionId    String   @map("session_id")
  deviceId     BigInt   @map("device_id")
  inode        BigInt
  offsetBytes  BigInt   @default(0) @map("offset_bytes")
  fileMtimeMs  BigInt   @map("file_mtime_ms")
  fileSizeBytes BigInt  @map("file_size_bytes")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([sessionId])
  @@map("usage_ingestion_cursors")
}

model SessionUsageAggregate {
  id               String   @id @default(cuid())
  sessionId        String   @unique @map("session_id")
  agentId          String   @map("agent_id")
  model            String?
  inputTokens      BigInt   @default(0) @map("input_tokens")
  outputTokens     BigInt   @default(0) @map("output_tokens")
  cacheReadTokens  BigInt   @default(0) @map("cache_read_tokens")
  cacheWriteTokens BigInt   @default(0) @map("cache_write_tokens")
  totalTokens      BigInt   @default(0) @map("total_tokens")
  totalCostMicros  BigInt   @default(0) @map("total_cost_micros")
  hasErrors        Boolean  @default(false) @map("has_errors")
  firstSeenAt      DateTime? @map("first_seen_at")
  lastSeenAt       DateTime? @map("last_seen_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  toolUsages       SessionToolUsage[]

  @@index([agentId, lastSeenAt])
  @@index([model, lastSeenAt])
  @@index([totalCostMicros])
  @@index([hasErrors])
  @@map("session_usage_aggregates")
}

model SessionToolUsage {
  id         String   @id @default(cuid())
  sessionId  String   @map("session_id")
  toolName   String   @map("tool_name")
  callCount  BigInt   @default(0) @map("call_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  session SessionUsageAggregate @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@unique([sessionId, toolName])
  @@index([toolName])
  @@index([sessionId])
  @@map("session_tool_usage")
}

// ============================================================================
// ERROR INGESTION + SIGNATURES
// ============================================================================

model ErrorIngestionCursor {
  id            String   @id @default(cuid())
  sourcePath    String   @unique @map("source_path")
  deviceId      BigInt   @map("device_id")
  inode         BigInt
  offsetBytes   BigInt   @default(0) @map("offset_bytes")
  fileMtimeMs   BigInt   @map("file_mtime_ms")
  fileSizeBytes BigInt   @map("file_size_bytes")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("error_ingestion_cursors")
}

model ErrorSignatureAggregate {
  id                 String   @id @default(cuid())
  signatureHash      String   @unique @map("signature_hash")
  signatureText      String   @map("signature_text")
  count              BigInt   @default(0)
  firstSeenAt        DateTime @map("first_seen_at")
  lastSeenAt         DateTime @map("last_seen_at")
  lastSampleSanitized String  @default("") @map("last_sample_sanitized")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([count])
  @@index([lastSeenAt])
  @@map("error_signature_aggregates")
}

model ErrorDailyAggregate {
  id         String   @id @default(cuid())
  day        DateTime @unique
  count      BigInt   @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([day])
  @@map("error_daily_aggregates")
}

// ============================================================================
// INGESTION LEASES
// ============================================================================

model IngestionLease {
  name       String   @id
  ownerId    String   @map("owner_id")
  acquiredAt DateTime @map("acquired_at")
  expiresAt  DateTime @map("expires_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([expiresAt])
  @@map("ingestion_leases")
}

// ============================================================================
// OPERATION COMPLETION TOKENS (IDEMPOTENCY)
// ============================================================================

model OperationCompletionToken {
  id          String   @id @default(cuid())
  token       String
  operationId String   @map("operation_id")
  workOrderId String?  @map("work_order_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([operationId])
  @@index([token])
  @@unique([operationId, token])
  @@map("operation_completion_tokens")
}

// ============================================================================
// APPROVALS
// ============================================================================

model Approval {
  id           String    @id @default(cuid())
  workOrderId  String    @map("work_order_id")
  operationId  String?   @map("operation_id")
  type         String    // ship_gate|risky_action|scope_change|cron_change|external_side_effect
  questionMd   String    @map("question_md")
  status       String    @default("pending") // pending|approved|rejected
  resolvedBy   String?   @map("resolved_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  resolvedAt   DateTime? @map("resolved_at")

  // Relations
  workOrder WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  operation Operation? @relation(fields: [operationId], references: [id], onDelete: SetNull)

  @@index([workOrderId])
  @@index([status])
  @@index([type])
  @@map("approvals")
}

// ============================================================================
// ACTIVITIES
// ============================================================================

model Activity {
  id          String   @id @default(cuid())
  ts          DateTime @default(now())
  type        String   // work_order.*, operation.*, agent.*, system.*, cron.*, etc.
  actor       String   // system|user|agent:<name>
  actorType   String   @default("system") @map("actor_type") // user|agent|system
  actorAgentId String? @map("actor_agent_id")
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  summary     String
  payloadJson String   @default("{}") @map("payload_json") // JSON

  @@index([ts])
  @@index([type])
  @@index([actorType])
  @@index([actorAgentId])
  @@index([entityType, entityId])
  @@map("activities")
}

// ============================================================================
// RECEIPTS
// ============================================================================

model Receipt {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  operationId     String?   @map("operation_id")
  kind            String    // playbook_step|cron_run|agent_run|manual
  commandName     String    @map("command_name")
  commandArgsJson String    @default("{}") @map("command_args_json") // JSON
  exitCode        Int?      @map("exit_code")
  durationMs      Int?      @map("duration_ms")
  stdoutExcerpt   String    @default("") @map("stdout_excerpt")
  stderrExcerpt   String    @default("") @map("stderr_excerpt")
  parsedJson      String?   @map("parsed_json") // JSON
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")

  // Relations
  workOrder WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  operation Operation? @relation(fields: [operationId], references: [id], onDelete: SetNull)

  @@index([workOrderId])
  @@index([kind])
  @@index([startedAt])
  @@map("receipts")
}

// ============================================================================
// ARTIFACTS
// ============================================================================

model Artifact {
  id          String   @id @default(cuid())
  workOrderId String   @map("work_order_id")
  operationId String?  @map("operation_id")
  type        String   // pr|doc|file|link|patch|screenshot|report
  title       String
  pathOrUrl   String   @map("path_or_url")
  createdBy   String   @map("created_by")
  createdByAgentId String? @map("created_by_agent_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  operation Operation? @relation(fields: [operationId], references: [id], onDelete: SetNull)

  @@index([workOrderId])
  @@index([type])
  @@index([createdByAgentId])
  @@map("artifacts")
}

// ============================================================================
// MESSAGES (for agent communication + FTS)
// ============================================================================

model Message {
  id          String   @id @default(cuid())
  workOrderId String   @map("work_order_id")
  role        String   // user|agent|system
  agentName   String?  @map("agent_name")
  content     String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================================================
// DOCUMENTS (general docs for FTS)
// ============================================================================

model Document {
  id        String   @id @default(cuid())
  type      String   // skill|playbook|overlay|readme|other
  path      String   @unique
  title     String
  content   String
  checksum  String   // for detecting changes
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@map("documents")
}

// ============================================================================
// CRON JOBS
// ============================================================================

model CronJob {
  id          String    @id @default(cuid())
  name        String    @unique
  schedule    String    // cron expression
  description String
  enabled     Boolean   @default(true)
  lastRunAt   DateTime? @map("last_run_at")
  nextRunAt   DateTime? @map("next_run_at")
  lastStatus  String?   @map("last_status") // success|failed|running
  runCount    Int       @default(0) @map("run_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("cron_jobs")
}

// ============================================================================
// SKILLS
// ============================================================================

model Skill {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  version     String
  enabled     Boolean   @default(true)
  usageCount  Int       @default(0) @map("usage_count")
  configJson  String    @default("{}") @map("config_json") // JSON
  lastUsedAt  DateTime? @map("last_used_at")
  installedAt DateTime  @default(now()) @map("installed_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("skills")
}

// ============================================================================
// PLUGINS
// ============================================================================

model Plugin {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  version     String
  author      String
  enabled     Boolean  @default(true)
  configJson  String   @default("{}") @map("config_json") // JSON
  installedAt DateTime @default(now()) @map("installed_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("plugins")
}

// ============================================================================
// SETTINGS (key-value store)
// ============================================================================

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
